{{- $rootSection := . -}}
{{- $p := .Parent -}}
{{- range seq 1 20 }}
    {{- if not $p }} {{- break -}} {{- end }}
    {{- $rootSection = $p -}}
    {{- if $p.Params.isTopLevel }} {{- break -}} {{- end }}
    {{- $p = $p.Parent -}}
{{- end -}}
{{- if not $rootSection.Params.isTopLevel }}
    {{- $rootSection = .FirstSection -}}
{{- end -}}

{{- define "renderTree" -}}
  {{- $node := .Node -}}
  {{- $currentPage := .CurrentPage -}}
  {{- $onlyFiles := .OnlyFiles | default false -}}

  {{- $sortedPages := slice -}}
  {{- range $node.Pages -}}
    {{- if or (not $onlyFiles) (and $onlyFiles (not .IsSection)) -}}
      {{- $weight := .Params.weight | default 0 -}}
      {{- $sortedPages = $sortedPages | append (dict "Page" . "Weight" $weight) -}}
    {{- end -}}
  {{- end -}}

  {{- $sortedPages = sort $sortedPages "Weight" "asc" -}}

  {{- range $sortedPages -}}
    {{- $page := .Page -}}
    {{- if and $page.IsSection (not $onlyFiles) -}}
      <details class="docs-folder" {{ if $page.IsAncestor $currentPage }}open{{ end }}>
        <summary>{{ $page.Title }}</summary>
        <div class="docs-folder-contents">
          {{- template "renderTree" (dict "Node" $page "CurrentPage" $currentPage "OnlyFiles" $onlyFiles) -}}
        </div>
      </details>
    {{- else if not $page.IsSection -}}
      <a href="{{ $page.RelPermalink }}" class="docs-file {{ if eq $page $currentPage }}active{{ end }}">
        {{- $page.Title -}}
      </a>
    {{- end -}}
  {{- end -}}
{{- end -}}

<nav class="docs-file-tree">
  <h3 class="docs-top-level-title">{{ $rootSection.Title }}</h3>
  {{- template "renderTree" (dict "Node" $rootSection "CurrentPage" .) -}}
</nav>